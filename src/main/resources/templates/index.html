<head>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
    <script src="https://unpkg.com/vue@2.5.13/dist/vue.js"></script>
    <!--Load controlling code development -->


<!--    <link rel="stylesheet" type="text/css" href="../static/css/game.css"/>-->
    <link rel="stylesheet"
          th:href="@{/css/game.css}" />
</head>
<body>

    <div id="gameApp">
        <p>Welcome to the Maze Game, written by <strong>{{authorName}}</strong>.</p>

        <!-- Manual buttons for control-->
        <p>
            <button type="button" v-on:click="newGame()">W
                New Game
            </button>

            <span v-if="game != null">
                <button type="button" v-on:click="cheat1Cheese()">
                    Cheat: 1 Cheese
                </button>
                <button type="button" v-on:click="cheatShowAll()">
                    Cheat: Show All
                </button>
                <button type="button" v-on:click="catMove()">
                    Force Cat Move
                </button>
            </span>
        </p>

        <!-- Game state -->
        <p v-if="game != null">
            You have found {{game.numCheeseFound}} of {{game.numCheeseGoal}}!</p>
        <p v-else>
            No game information available; try creating a new game?
        </p>


        <!-- Board -->
        <div v-if="board != null">
            <table>
                <tr v-for="(row, rowIdx) in board.hasWalls">
                    <td v-for="(isWall, colIdx) in row">
                        <div style="position: relative; left:0; top:0;">
                            <!-- Background -->
                            <img v-if="!board.isVisible[rowIdx][colIdx]" src="https://www.sfu.ca/~xuetianw/img/empty.png"/>
                            <img v-else-if="isWall" src="https://www.sfu.ca/~xuetianw/img/wall.png" />
                            <img v-else src="https://www.sfu.ca/~xuetianw/img/field.png"/>

                            <!-- Sprites: stack them on top of each other using relative position -->
                            <img v-if="locationMatches(board.cheeseLocation, colIdx, rowIdx)"
                                 src="https://www.sfu.ca/~xuetianw/img/cookie.png" class="stack"/>
                            <div v-if="locationMatches(board.mouseLocation, colIdx, rowIdx)">
                                <!-- Player image depends on if won/lost/playing -->
                                <img v-if="game.isGameWon" src="https://www.sfu.ca/~xuetianw/img/smile.png" class="stack"/>
                                <img v-else-if="game.isGameLost" src="https://www.sfu.ca/~xuetianw/img/cancel.png" class="stack"/>
                                <img v-else src="https://www.sfu.ca/~xuetianw/img/person.png" class="stack"/>
                            </div>
                            <div v-for="catLoc in board.catLocations">
                                <img v-if="locationMatches(catLoc, colIdx, rowIdx)"
                                     src="https://www.sfu.ca/~xuetianw/img/fox.png" class="stack"/>
                            </div>
                        </div>
                    </td>
                </tr>
            </table>

            <!-- Won / loss -->
            <h1 v-if="game.isGameWon">YOU WON! Congratulations!</h1>
            <h1 v-if="game.isGameLost">YOU LOST! Try again?</h1>

            <!-- Buttons for testing -->
            <h2>Testing API Error Handling</h2>
            <p>
                <button type="button" v-on:click="getBadGame()">
                    Test: Bad Game
                </button>
                <button type="button" v-on:click="getBadBoard()">
                    Test: Bad Board
                </button>
                <button type="button" v-on:click="doBadCheat()">
                    Test: Bad Cheat
                </button>
                <button type="button" v-on:click="doBadMove()">
                    Test: Bad Move
                </button>
            </p>
        </div>
    </div>


    <p>Icons created by <a href="https://www.everaldo.com/about">Everaldo Coelho</a>
        as part of the <a href="https://www.iconfinder.com/iconsets/crystalproject">Crystal Project</a>;
        used under LGPL.</p>
    <script>"use strict";

    // Handle back-end server interactions fro game UI.
    const myAppObj = new Vue({
        el: "#gameApp",
        data: {
            authorName: "(waiting for server...)",
            // playersTurn: true,
            game: null,
            board: null,
        },

        methods: {
            newGame: makeNewGame,
            cheat1Cheese: send1CheeseCheat,
            cheatShowAll: sendShowAll,
            catMove: sendMoveCats,

            // Testing error handling
            getBadGame: testGetBadGame,
            getBadBoard: testGetBadBoard,
            doBadCheat: testDoBadCheat,
            doBadMove: testDoBadMove,

            locationMatches: function(loc, x, y) {
                return loc.x == x && loc.y == y;
            },
        }
    });

    // Have Axios send body as plain text (not JSON) when this config is passed to a POST request.
    var plainTextConfig = {
        headers: { 'Content-Type': 'text/plain'},
        responseType: 'text'
    };

    // Handle arrow keys
    window.addEventListener('keydown', function(e) {
        console.log("Key pressed: " + e.keyCode);
        switch(e.keyCode) {
            case 37: sendMove("MOVE_LEFT"); break;
            case 38: sendMove("MOVE_UP"); break;
            case 39: sendMove("MOVE_RIGHT"); break;
            case 40: sendMove("MOVE_DOWN"); break;
        }
    });

    // Refresh UI at start
    $(document).ready(function() {
        loadAbout();
        window.setInterval(function () {
            loadGameBoard()
        }, 1000);
    });

    function loadAbout() {
        axios.get('/api/about', {})
            .then(function (response) {
                console.log("GET About returned:", response);
                myAppObj.authorName = response.data;

                alertOnWrongStatus("GET about", 200, response.status);
            })
            .catch(function (error) {
                console.log("GET About ERROR:", error);
            });
    }

    function makeNewGame() {
        axios.post('api/games', {})
            .then(function (response) {
                console.log("POST new game returned:", response);
                myAppObj.game = response.data;
                // myAppObj.playersTurn = true;
                loadGameBoard();

                alertOnWrongStatus("POST games", 201, response.status);
            })
            .catch(function (error) {
                console.log("POST new game ERROR:", error);
            });
    }

    function loadGame() {
        axios.get('/api/games/' + myAppObj.game.gameNumber, {})
            .then(function (response) {
                console.log("Load game returned:", response);
                myAppObj.game = response.data;

                alertOnWrongStatus("GET Game", 200, response.status);
            })
            .catch(function (error) {
                console.log("Load game ERROR: ", error);
            });
    }
    function loadGameBoard() {
        axios.get('/api/games/' + myAppObj.game.gameNumber + "/board", {})
            .then(function (response) {
                console.log("Load Board returned: ", response);
                myAppObj.board = response.data;

                alertOnWrongStatus("GET board", 200, response.status);
            })
            .catch(function (error) {
                console.log("Load Board ERROR: ", error);
            });
    }
    function send1CheeseCheat() {
        axios.post('/api/games/' + myAppObj.game.gameNumber + "/cheatstate", "1_CHEESE", plainTextConfig)
            .then(function (response) {
                console.log("Cheat returned: ", response);
                loadGame();
                alertOnWrongStatus("POST Cheese Cheat", 202, response.status);
            })
            .catch(function (error) {
                console.log("Cheat ERROR: ", error);
            });
    }
    function sendShowAll() {
        axios.post('/api/games/' + myAppObj.game.gameNumber + "/cheatstate", "SHOW_ALL", plainTextConfig)
            .then(function (response) {
                console.log("Cheat returned: ", response);
                loadGameBoard();
                alertOnWrongStatus("POST Show All Cheat", 202, response.status);
            })
            .catch(function (error) {
                console.log("Cheat ERROR: ", error);
            });
    }
    function sendMoveCats() {
        if (myAppObj.game.isGameLost || myAppObj.game.isGameWon) {
            console.log("Cats cannot make move after game has ended.");
            return;
        }

        axios.post('/api/games/' + myAppObj.game.gameNumber + "/moves", "MOVE_CATS", plainTextConfig)
            .then(function (response) {
                console.log("Cat move returned: ", response);
                myAppObj.playersTurn = true;
                loadGameBoard();
                loadGame();
                alertOnWrongStatus("POST Cats Move", 202, response.status);
            })
            .catch(function (error) {
                console.log("Cat move ERROR: ", error);
            });
    }

    function sendMove(directionStr) {
        // if (!myAppObj.playersTurn) {
        //     console.log("Not player's turn yet! Cats must move.");
        //     return;
        // }

        if (myAppObj.game.isGameLost || myAppObj.game.isGameWon) {
            console.log("Unable to make move after game has ended.");
            return;
        }

        axios.post('/api/games/' + myAppObj.game.gameNumber + "/moves", directionStr, plainTextConfig)
            .then(function (response) {
                console.log("Move player returned:", response);
                loadGameBoard();
                loadGame();

                // Cats go next, after a moment
                // myAppObj.playersTurn = false;
                // setTimeout(sendMoveCats, 100);
                alertOnWrongStatus("POST Mouse Move", 202, response.status);
            })
            .catch(function (error) {
                // Did they bump the wall?
                if (error.response.status == 400) {
                    console.log("Move player: hit the wall.");
                    playSound();
                } else {
                    console.log("Move player ERROR:", error);
                }
            });
    }

    // Source: https://www.w3schools.com/graphics/game_sound.asp
    var mySound = new sound("res/BONK.WAV");
    function sound(src) {
        this.sound = document.createElement("audio");
        this.sound.src = src;
        this.sound.setAttribute("preload", "auto");
        this.sound.setAttribute("controls", "none");
        this.sound.style.display = "none";
        document.body.appendChild(this.sound);
        this.play = function(){
            this.sound.play();
        }
        this.stop = function(){
            this.sound.pause();
        }
    }
    function playSound() {
        mySound.play();
    }



    // Testing Functions
    function testGetBadGame() {
        testErrorHandling(
            "Test Get Bad Game",
            "GET",
            '/api/games/' + 2352523,
            "",
            404);
    }
    function testGetBadBoard() {
        testErrorHandling(
            "Test Get Bad Board",
            "GET",
            '/api/games/' + 2352523 + "/board",
            "",
            404);
    }
    function testDoBadCheat() {
        testErrorHandling(
            "Test Cheat on bad game",
            "POST",
            '/api/games/' + 2352523 + "/cheatstate",
            "1_CHEESE",
            404);

        testErrorHandling(
            "Test Bad Move",
            "POST",
            '/api/games/' + myAppObj.game.gameNumber + "/moves",
            "NoSuchCheat",
            400);
    }
    function testDoBadMove() {
        testErrorHandling(
            "Test Move on bad game",
            "POST",
            '/api/games/' + 2352523 + "/moves",
            "MOVE_UP",
            404);

        testErrorHandling(
            "Test Bad Move",
            "POST",
            '/api/games/' + myAppObj.game.gameNumber + "/moves",
            "NoSuchMove",
            400);
    }
    function testErrorHandling(name, method, url, data, result) {
        axios( {
            method: method,
            url: url,
            data: data,
            config: plainTextConfig
        })
            .then(function (response) {
                alert(name + ": Did *not* fail when it should have! (expected " + result + ")");
            })
            .catch(function (error) {
                if (error.response.status != result) {
                    console.log(name + ": Returned incorrect error response code (expected " + result + "): ", error.response)
                    alert(name + ": Returned incorrect error response code (expected " + result + ")")
                } else {
                    console.log(name + ": returned the correct response code: ", error)
                }
            });
    }



    function alertOnWrongStatus(description, expectedStatus, actualStatus) {
        if (actualStatus != expectedStatus) {
            alert("ERROR: Incorrect HTTP status returned for ["
                + description
                + "]; expected " + expectedStatus
                + " but server returned " + actualStatus)
        }
    }


    </script>
</body>